{% extends "base.html" %}

{% block title %}Manage Safety Zones{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Map Section -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Safety Zones Map</h5>
                    <button class="btn btn-primary" id="addZoneBtn">
                        <i class="fas fa-plus"></i> Add New Zone
                    </button>
                </div>
                <div class="card-body">
                    <div id="map" style="height: 500px;"></div>
                    <div id="mapError" class="alert alert-danger mt-3" style="display: none;">
                        Error loading map. Please check your internet connection and try again.
                    </div>
                </div>
            </div>
        </div>

        <!-- Zones List -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Your Safety Zones</h5>
                </div>
                <div class="card-body">
                    <div class="list-group" id="zonesList">
                        {% for zone in zones %}
                        <div class="list-group-item" data-zone-id="{{ zone.id }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ zone.name }}</h6>
                                <div>
                                    <button class="btn btn-sm btn-info edit-zone-btn" data-zone-id="{{ zone.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-zone-btn" data-zone-id="{{ zone.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <p class="mb-1">{{ zone.description or 'No description' }}</p>
                            <small>Radius: {{ zone.radius }}m</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Zone Modal -->
<div class="modal fade" id="zoneModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="zoneModalTitle">Add Safety Zone</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="zoneForm">
                    <input type="hidden" id="zoneId">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="zoneName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Radius (meters)</label>
                        <input type="number" class="form-control" id="zoneRadius" required min="100" max="5000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="zoneDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveZoneBtn">Save Zone</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Add Google Maps API with required libraries -->
<script>
let map;
let currentLocation;
let markers = [];
let circles = [];

function initMap() {
    try {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: 13,
            center: { lat: 0, lng: 0 }
        });

        // Get user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(currentLocation);
                    
                    // Add user marker
                    new google.maps.Marker({
                        position: currentLocation,
                        map: map,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: '#4285F4',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 2
                        }
                    });
                },
                error => {
                    console.error('Error getting location:', error);
                    showAlert('Unable to get your location. Please enable location services.', 'warning');
                }
            );
        }

        // Load existing zones
        loadZones();
    } catch (error) {
        console.error('Error initializing map:', error);
        document.getElementById('mapError').style.display = 'block';
    }
}

function loadZones() {
    fetch('/api/safety-zones')
        .then(response => response.json())
        .then(zones => {
            // Clear existing markers and circles
            markers.forEach(marker => marker.setMap(null));
            circles.forEach(circle => circle.setMap(null));
            markers = [];
            circles = [];

            // Add zones to map
            zones.forEach(zone => {
                const position = { lat: zone.latitude, lng: zone.longitude };
                
                // Add marker
                const marker = new google.maps.Marker({
                    position: position,
                    map: map,
                    title: zone.name
                });
                markers.push(marker);

                // Add circle
                const circle = new google.maps.Circle({
                    strokeColor: '#FF0000',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: '#FF0000',
                    fillOpacity: 0.35,
                    map: map,
                    center: position,
                    radius: zone.radius
                });
                circles.push(circle);
            });
        })
        .catch(error => {
            console.error('Error loading zones:', error);
            showAlert('Error loading safety zones', 'danger');
        });
}

function addSafetyZone() {
    document.getElementById('zoneModalTitle').textContent = 'Add Safety Zone';
    document.getElementById('zoneForm').reset();
    document.getElementById('zoneId').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('zoneModal'));
    modal.show();
}

function editZone(zoneId) {
    document.getElementById('zoneModalTitle').textContent = 'Edit Safety Zone';
    document.getElementById('zoneId').value = zoneId;
    
    fetch(`/api/safety-zones/${zoneId}`)
        .then(response => response.json())
        .then(zone => {
            document.getElementById('zoneName').value = zone.name;
            document.getElementById('zoneRadius').value = zone.radius;
            document.getElementById('zoneDescription').value = zone.description || '';
            
            const modal = new bootstrap.Modal(document.getElementById('zoneModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading zone:', error);
            showAlert('Error loading zone details', 'danger');
        });
}

function saveZone() {
    const zoneId = document.getElementById('zoneId').value;
    const data = {
        name: document.getElementById('zoneName').value,
        radius: parseFloat(document.getElementById('zoneRadius').value),
        description: document.getElementById('zoneDescription').value,
        latitude: currentLocation.lat,
        longitude: currentLocation.lng
    };

    const url = zoneId ? `/api/safety-zones/${zoneId}` : '/api/safety-zones';
    const method = zoneId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            throw new Error(result.error);
        }
        bootstrap.Modal.getInstance(document.getElementById('zoneModal')).hide();
        showAlert(result.message, 'success');
        loadZones();
    })
    .catch(error => {
        console.error('Error saving zone:', error);
        showAlert('Error saving safety zone: ' + error.message, 'danger');
    });
}

function deleteZone(zoneId) {
    if (!confirm('Are you sure you want to delete this safety zone?')) {
        return;
    }

    fetch(`/api/safety-zones/${zoneId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            throw new Error(result.error);
        }
        showAlert(result.message, 'success');
        loadZones();
    })
    .catch(error => {
        console.error('Error deleting zone:', error);
        showAlert('Error deleting safety zone: ' + error.message, 'danger');
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    setTimeout(() => alertDiv.remove(), 5000);
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Add Zone button
    document.getElementById('addZoneBtn').addEventListener('click', addSafetyZone);
    
    // Save Zone button
    document.getElementById('saveZoneBtn').addEventListener('click', saveZone);
    
    // Edit Zone buttons
    document.querySelectorAll('.edit-zone-btn').forEach(button => {
        button.addEventListener('click', function() {
            const zoneId = this.getAttribute('data-zone-id');
            editZone(zoneId);
        });
    });
    
    // Delete Zone buttons
    document.querySelectorAll('.delete-zone-btn').forEach(button => {
        button.addEventListener('click', function() {
            const zoneId = this.getAttribute('data-zone-id');
            deleteZone(zoneId);
        });
    });
});

// Load Google Maps API
const script = document.createElement('script');
script.src = `https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places,drawing,geometry&callback=initMap`;
script.async = true;
script.defer = true;
document.head.appendChild(script);
</script>

<style>
.card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.list-group-item {
    border: none;
    border-bottom: 1px solid #eee;
}

.list-group-item:last-child {
    border-bottom: none;
}

.btn {
    border-radius: 25px;
    padding: 8px 16px;
}

.btn-sm {
    padding: 4px 8px;
    border-radius: 15px;
}
</style>
{% endblock %} 
{% extends "base.html" %}

{% block title %}Manage Contacts{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Manage Emergency Contacts</h2>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Your Contacts</h5>
                    <button class="btn btn-primary" onclick="showAddContactModal()">
                        <i class="fas fa-plus"></i> Add Contact
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Relationship</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contactsTableBody">
                                <!-- Contacts will be loaded here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Contact Guidelines</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success"></i>
                            Add at least 2 emergency contacts
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success"></i>
                            Keep contact information up to date
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success"></i>
                            Include family members or close friends
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check-circle text-success"></i>
                            Verify phone numbers regularly
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addContactForm">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" name="phone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Relationship</label>
                        <input type="text" class="form-control" name="relationship">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addContact()">Add Contact</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Contact Modal -->
<div class="modal fade" id="editContactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editContactForm">
                    <input type="hidden" name="id">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" name="phone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Relationship</label>
                        <input type="text" class="form-control" name="relationship">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateContact()">Update Contact</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let contacts = [];
let addContactModal;
let editContactModal;

document.addEventListener('DOMContentLoaded', function() {
    addContactModal = new bootstrap.Modal(document.getElementById('addContactModal'));
    editContactModal = new bootstrap.Modal(document.getElementById('editContactModal'));
    loadContacts();
});

function loadContacts() {
    fetch('/api/contacts')
        .then(response => response.json())
        .then(data => {
            contacts = data;
            displayContacts();
        })
        .catch(error => {
            showAlert('Error loading contacts: ' + error.message, 'danger');
        });
}

function displayContacts() {
    const tbody = document.getElementById('contactsTableBody');
    tbody.innerHTML = '';
    
    contacts.forEach(contact => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${contact.name}</td>
            <td>${contact.phone}</td>
            <td>${contact.relationship || '-'}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editContact(${contact.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteContact(${contact.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function showAddContactModal() {
    document.getElementById('addContactForm').reset();
    addContactModal.show();
}

function addContact() {
    const form = document.getElementById('addContactForm');
    const formData = new FormData(form);
    const data = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        relationship: formData.get('relationship')
    };

    fetch('/api/contacts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        addContactModal.hide();
        showAlert('Contact added successfully', 'success');
        loadContacts();
    })
    .catch(error => {
        showAlert('Error adding contact: ' + error.message, 'danger');
    });
}

function editContact(id) {
    const contact = contacts.find(c => c.id === id);
    if (!contact) return;

    const form = document.getElementById('editContactForm');
    form.querySelector('[name="id"]').value = contact.id;
    form.querySelector('[name="name"]').value = contact.name;
    form.querySelector('[name="phone"]').value = contact.phone;
    form.querySelector('[name="relationship"]').value = contact.relationship || '';

    editContactModal.show();
}

function updateContact() {
    const form = document.getElementById('editContactForm');
    const formData = new FormData(form);
    const id = formData.get('id');
    const data = {
        name: formData.get('name'),
        phone: formData.get('phone'),
        relationship: formData.get('relationship')
    };

    fetch(`/api/contacts/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        editContactModal.hide();
        showAlert('Contact updated successfully', 'success');
        loadContacts();
    })
    .catch(error => {
        showAlert('Error updating contact: ' + error.message, 'danger');
    });
}

function deleteContact(id) {
    if (!confirm('Are you sure you want to delete this contact?')) {
        return;
    }

    fetch(`/api/contacts/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        showAlert('Contact deleted successfully', 'success');
        loadContacts();
    })
    .catch(error => {
        showAlert('Error deleting contact: ' + error.message, 'danger');
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
    setTimeout(() => alertDiv.remove(), 5000);
}
</script>
{% endblock %} 